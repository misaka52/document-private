## 1、分布式架构

### 从ACID到CAP/BASE

#### CAP

一致性-C：保证分布式节点的数据一致性。分为强一致性和最终一致性

可用性-A：服务一直可用，对于客户端请求都能在一定时间内返回处理结果

分区容错性-P：系统存在多个副本，保证高可用性，但其中一个副本怪了其他副本仍然可用

放弃P：数据都放在单节点上，保证强一致性。

放弃A：当遇到网络分区或故障时，收到影响的服务要等待一定时间，即服务不可用

放弃C：放弃强一致性， 允许数据短暂的不一致性。常用

#### BASE理论

basically avaiable(基本可用)：允许损失部分可用性。响应时间上的损失：当出现故障时允许查询结果的响应时间增加的1-2s；功能上的损失，当大促期间抢购商品时，部分用户直接降级或熔断

Soft state(软状态)：也成为若状态，允许系统的数据存在中间状态，允许不同节点间数据在同步过程中存在延迟

eventually consistent(最终一致性)：保证数据最终能达到一致的状态

## 2、一致性协议

### 2.1 2PC和3PC

#### 2.1.1 2PC

**事务询问**：协调者询问并锁定参与者相关资源。参与者锁定资源会一致性等待协调者的命令，提交或回滚，无超时限制

**等待响应**：协调者等待所有参与者返回ok。若存在一个参与者返回失败或超时，则向所有参与者发送回滚消息；否则发送事务提交消息

**事务提交**：参与者收到提交消息后，提交事务，并释放响应资源。返回ack

**完成事务**：协调者收到所有参与者ack之后，完成事务

2PC优点：原理简单实现方便

2PC缺点

1. 同步阻塞：参与者在一阶段询问之后锁定资源，必须等待协调者的二阶段消息才能提交或回滚，释放资源
2. 单点问题：协调者若出现问题，2PC阶段无法成功完成。特别是在一阶段参与者锁定资源之后，若协调者宕机则会导致参与者资源一直被锁定
3. 数据不一致：当协调者二阶段发送提交或回滚消息时，可能导致部分消息发送成功后协调者宕机，导致各参与者数据不一致
4. 太过保守：协调者进行事务提交询问时，只能等待参与者反馈或超时机制得到结果，没有合适的容错机制

#### 2.1.2 3PC

**CanCommit**：协调者询问参与者能否执行事务

**PreCommit**：参与者事务预提交，锁定事务资源。参与者存在超时机制，默认超时提交事务

**DoCommit**：参与者事务提交或回滚